name: Microweber build & upload
on: [push,pull_request]

jobs:
  microweber-test-before-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install Dependencies
        run: composer install

      - name: Dump autoload dependecies
        run: composer dump-autoload

      - name: Run PHPUnit
        run: php artisan test --debug

      - name: Send skype failure
        if: failure()
        uses: bobimicroweber/docker-action-send-skype@v1
        with:
          skype_username: ${{ secrets.SKYPE_USERNAME }}
          skype_password: ${{ secrets.SKYPE_PASSWORD }}
          skype_ids: ${{ secrets.SKYPE_SPAM_GROUP_ID }}
          send_msg_text: "${{ env.GITHUB_REF_SLUG }} unit test failure. (bomb) \nCommit message: ${{ github.event.head_commit.message }} \nPushed by: (penguin) ${{github.actor}}"

  microweber-build-and-upload:
    runs-on: ubuntu-latest
    needs: microweber-test-before-build
    steps:
    - uses: actions/checkout@v2

    - name: Install Dependencies
      run: composer install

    - name: Dump autoload dependecies
      run: composer dump-autoload

    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v3.x

    - name: Zip the files
      run: |
        rm -rf .git
        rm -rf .github
        find . \( -name ".git" -o -name ".gitignore" -o -name ".gitmodules" -o -name ".gitattributes" \) -exec rm -rf -- {} +
        zip -r microweber-${{ env.GITHUB_REF_SLUG }}.zip `ls -A`
        curl -T microweber-${{ env.GITHUB_REF_SLUG }}.zip ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}
        cp microweber-${{ env.GITHUB_REF_SLUG }}.zip microweber.zip
        curl -T microweber.zip ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}/builds/${{ env.GITHUB_REF_SLUG }}/ --ftp-create-dirs
    - name: Upload composer.json
      run: |
        cp -r composer.json microweber-${{ env.GITHUB_REF_SLUG }}.composer.json
        curl -T microweber-${{ env.GITHUB_REF_SLUG }}.composer.json ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}
        curl -T composer.json ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}/builds/${{ env.GITHUB_REF_SLUG }}/ --ftp-create-dirs
        curl -T composer.lock ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}/builds/${{ env.GITHUB_REF_SLUG }}/ --ftp-create-dirs
    - name: Upload version.txt
      run: |
        cp -r version.txt microweber-${{ env.GITHUB_REF_SLUG }}.version.txt
        curl -T microweber-${{ env.GITHUB_REF_SLUG }}.version.txt ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}
        curl -T version.txt ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}/builds/${{ env.GITHUB_REF_SLUG }}/ --ftp-create-dirs
        curl -T CHANGELOG.md ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}/builds/${{ env.GITHUB_REF_SLUG }}/ --ftp-create-dirs
        curl -T README.md ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}/builds/${{ env.GITHUB_REF_SLUG }}/ --ftp-create-dirs
    - name: Send skype
      uses: bobimicroweber/docker-action-send-skype@v1
      with:
        skype_username : ${{ secrets.SKYPE_USERNAME }}
        skype_password : ${{ secrets.SKYPE_PASSWORD }}
        skype_ids      : ${{ secrets.SKYPE_SPAM_GROUP_ID }}
        send_msg_text  : "${{ env.GITHUB_REF_SLUG }} branch are updated for standalone updater module. (checkmark) \nCommit message: ${{ github.event.head_commit.message }} \nPushed by: (penguin) ${{github.actor}}"

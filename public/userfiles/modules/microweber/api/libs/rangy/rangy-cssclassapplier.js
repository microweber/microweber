!function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("ClassApplier",["WrappedSelection"],function(n,c){var f=n.dom,i=f.DomPosition,r=f.arrayContains,e=n.util,m=e.forEach,j=e.isHostMethod(document,"createElementNS");function p(e,t){for(var n in e)if(e.hasOwnProperty(n)&&!1===t(n,e[n]))return!1;return!0}function d(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function o(e,t){return!!e&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e)}function a(e,t){return"object"==typeof e.classList?e.classList.contains(t):o("string"==typeof e.className?e.className:e.getAttribute("class"),t)}function h(e,t){var n,s;"object"==typeof e.classList?e.classList.add(t):((s=(n="string"==typeof e.className)?e.className:e.getAttribute("class"))?o(s,t)||(s+=" "+t):s=t,n?e.className=s:e.setAttribute("class",s))}var g=function(e,t){var n,s;"object"==typeof e.classList?e.classList.remove(t):(s=(s=(n="string"==typeof e.className)?e.className:e.getAttribute("class")).replace(new RegExp("(^|\\s)"+t+"(\\s|$)"),$),n?e.className=s:e.setAttribute("class",s))};function $(e,t,n){return t&&n?" ":""}function t(e){return"string"==typeof e.className?e.className:e.getAttribute("class")}function N(e){return e&&e.split(/\s+/).sort().join(" ")}function s(e){return N(t(e))}function l(e,t){return s(e)==s(t)}function u(e,t){for(var n=t.split(/\s+/),s=0,i=n.length;s<i;++s)if(!a(e,d(n[s])))return!1;return!0}function y(e,l,u,t){-1==u&&(u=l.childNodes.length);var c=e.parentNode,p=f.getNodeIndex(e);m(t,function(e){var t,n,s,i,r,o,a;t=p,n=l,s=u,i=(e=e).node,r=e.offset,a=r,(o=i)==n&&s<r&&++a,i!=c||r!=t&&r!=t+1||(o=n,a+=s-t),i==c&&t+1<r&&--a,e.node=o,e.offset=a}),l.childNodes.length==u?l.appendChild(e):l.insertBefore(e,l.childNodes[u])}function v(e,t){var n=e.parentNode,s=f.getNodeIndex(e);m(t,function(e){var t;t=s,(e=e).node==n&&e.offset>t&&--e.offset}),f.removeNode(e)}function C(e,t){for(var n,s=e,i=e.parentNode,r=f.getNodeIndex(e),e=!0,o=t,a=[];n=s.firstChild;)y(n,i,r++,o),a.push(n);return e&&v(s,o),a}function T(e,t){var n=e.cloneRange(),t=(n.selectNodeContents(t),n.intersection(e));return""!=(t?t.toString():"")}function E(e){for(var t,n=e.getNodes([3]),s=0;(t=n[s])&&!T(e,t);)++s;for(var i=n.length-1;(t=n[i])&&!T(e,t);)--i;return n.slice(s,i+1)}function b(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,s,i=0,r=e.attributes.length;i<r;++i)if("class"!=(s=(n=e.attributes[i]).name)){if(null===n!=(null===(s=t.attributes.getNamedItem(s))))return!1;if(n.specified!=s.specified)return!1;if(n.specified&&n.nodeValue!==s.nodeValue)return!1}return!0}function A(e,t){for(var n,s=0,i=e.attributes.length;s<i;++s)if(n=e.attributes[s].name,(!t||!r(t,n))&&e.attributes[s].specified&&"class"!=n)return!0;return!1}var S=f.getComputedStyleProperty,x="boolean"==typeof document.createElement("div").isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return!(!e||1!=e.nodeType||"false"==e.contentEditable)&&("true"==e.contentEditable||x(e.parentNode))};function R(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||x(e)&&!x(e.parentNode))}function P(e){return(x(e)||1!=e.nodeType&&x(e.parentNode))&&!R(e)}var z=/^inline(-block|-table)?$/i;function w(e){return e&&1==e.nodeType&&!z.test(S(e,"display"))}var B=/[^\r\n\t\f \u200B]/;function O(e){for(var t,n=[],s=0;t=e[s++];)n.push(new i(t.startContainer,t.startOffset),new i(t.endContainer,t.endOffset));return n}function I(e,t){for(var n,s,i,r=0,o=e.length;r<o;++r)n=e[r],s=t[2*r],i=t[2*r+1],n.setStartAndEnd(s.node,s.offset,i.node,i.offset)}function W(e,t,n,s){var i,r,o=0==n;if(f.isAncestorOf(t,e))return e;if(f.isCharacterDataNode(t)){var a=f.getNodeIndex(t);if(0==n)n=a;else{if(n!=t.length)throw c.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+n+" in "+t.data);n=a+1}t=t.parentNode}if(a=t,r=n,f.isCharacterDataNode(a)?0==r?a.previousSibling:r!=a.length||a.nextSibling:0<r&&r<a.childNodes.length){i=t.cloneNode(!1),r=t.parentNode,i.id&&i.removeAttribute("id");for(var l,u=0;l=t.childNodes[n];)y(l,i,u++,s);return y(i,r,f.getNodeIndex(t)+1,s),t==e?i:W(e,r,f.getNodeIndex(i),s)}return e!=t?(i=t.parentNode,r=f.getNodeIndex(t),o||r++,W(e,i,r,s)):e}function L(s){var i=s?"nextSibling":"previousSibling";return function(e,t){var n=e.parentNode,e=e[i];if(e){if(3==e.nodeType)return e}else if(t&&(e=n[i])&&1==e.nodeType&&(t=e,(n=n).namespaceURI==t.namespaceURI&&n.tagName.toLowerCase()==t.tagName.toLowerCase()&&l(n,t)&&b(n,t)&&"inline"==S(n,"display")&&"inline"==S(t,"display"))){n=e[s?"firstChild":"lastChild"];if(n&&3==n.nodeType)return n}return null}}var D=L(!1),U=L(!0);function M(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];e=this.isElementMerge?e.lastChild:e;e&&(this.textNodes[0]=e)}var V=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],k={};function H(e,t,n){var s,i,r,o=this,a=(o.cssClass=o.className=e,null),l={};if("object"==typeof t&&null!==t){for(void 0!==t.elementTagName&&(t.elementTagName=t.elementTagName.toLowerCase()),n=t.tagNames,a=t.elementProperties,l=t.elementAttributes,s=0;r=V[s++];)t.hasOwnProperty(r)&&(o[r]=t[r]);u=t.normalize}else u=t;o.normalize=void 0===u||u,o.attrExceptions=[];var u=document.createElement(o.elementTagName),a=(o.elementProperties=o.copyPropertiesToElement(a,u,!0),p(l,function(e,t){o.attrExceptions.push(e),l[e]=""+t}),o.elementAttributes=l,o.elementSortedClassName=o.elementProperties.hasOwnProperty("className")?N(o.elementProperties.className+" "+e):e,o.applyToAnyTagName=!1,typeof n);if("string"==a)"*"==n?o.applyToAnyTagName=!0:o.tagNames=d(n.toLowerCase()).split(/\s*,\s*/);else if("object"==a&&"number"==typeof n.length)for(o.tagNames=[],s=0,i=n.length;s<i;++s)"*"==n[s]?o.applyToAnyTagName=!0:o.tagNames.push(n[s].toLowerCase());else o.tagNames=[o.elementTagName]}H.prototype={elementTagName:"span",elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!(M.prototype={doMerge:function(e){var s,i,r,o,a=this.textNodes,l=a[0];return 1<a.length&&(s=f.getNodeIndex(l),i=[],r=0,m(a,function(t,n){o=t.parentNode,0<n&&(o.removeChild(t),o.hasChildNodes()||f.removeNode(o),e&&m(e,function(e){e.node==t&&(e.node=l,e.offset+=r),e.node==o&&e.offset>s&&(--e.offset,e.offset==s+1&&n<a.length-1&&(e.node=l,e.offset=r))})),i[n]=t.data,r+=t.data.length}),l.data=i.join("")),l.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){var n=[];return m(this.textNodes,function(e,t){n[t]="'"+e.data+"'"}),"[Merge("+n.join(",")+")]"}}),useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var s,i,r,o,a,l,u={};for(l in e)if(e.hasOwnProperty(l))if(o=e[l],a=t[l],"className"==l)h(t,o),h(t,this.className),t[l]=N(t[l]),n&&(u[l]=o);else if("style"==l){for(s in i=a,n&&(u[l]=r={}),e[l])e[l].hasOwnProperty(s)&&(i[s]=o[s],n&&(r[s]=i[s]));this.attrExceptions.push(l)}else t[l]=o,n&&(u[l]=t[l],a=k.hasOwnProperty(l)?k[l]:l,this.attrExceptions.push(a));return n?u:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&!/^class(?:Name)?$/i.test(n)&&t.setAttribute(n,e[n])},appliesToElement:function(e){return r(this.tagNames,e.tagName.toLowerCase())},getEmptyElements:function(e){var t=this;return e.getNodes([1],function(e){return t.appliesToElement(e)&&!e.hasChildNodes()})},hasClass:function(e){return 1==e.nodeType&&(this.applyToAnyTagName||this.appliesToElement(e))&&a(e,this.className)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||P(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&function(e){if(0==e.data.length)return!0;if(B.test(e.data))return!1;switch(S(e.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return w(e.previousSibling)||w(e.nextSibling)}(e)},postApply:function(e,t,n,s){var i,r,o=e[0],a=e[e.length-1],l=[],u=o,c=a,p=0,f=a.length,e=(m(e,function(e){(r=D(e,!s))?(i||(i=new M(r),l.push(i)),i.textNodes.push(e),e===o&&(u=i.textNodes[0],p=u.length),e===a&&(c=i.textNodes[0],f=i.getLength())):i=null}),U(a,!s));if(e&&(i||(i=new M(a),l.push(i)),i.textNodes.push(e)),l.length){for(var d=0,h=l.length;d<h;++d)l[d].doMerge(n);t.setStartAndEnd(u,p,c,f)}},createContainer:function(e){var t=f.getDocument(e),e=j&&!f.isHtmlNamespace(e)&&e.namespaceURI?t.createElementNS(e.namespaceURI,this.elementTagName):t.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,e,!1),this.copyAttributesToElement(this.elementAttributes,e),h(e,this.className),this.onElementCreate&&this.onElementCreate(e,this),e},elementHasProperties:function(n,e){var s=this;return p(e,function(e,t){if("className"==e)return u(n,t);if("object"==typeof t){if(!s.elementHasProperties(n[e],t))return!1}else if(n[e]!==t)return!1})},elementHasAttributes:function(n,e){return p(e,function(e,t){if(n.getAttribute(e)!==t)return!1})},applyToTextNode:function(e,t){var n,s;(s=(s=e).parentNode)&&1==s.nodeType&&!/^(textarea|style|script|select|iframe)$/i.test(s.nodeName)&&(1==(s=e.parentNode).childNodes.length&&this.useExistingElements&&this.appliesToElement(s)&&this.elementHasProperties(s,this.elementProperties)&&this.elementHasAttributes(s,this.elementAttributes)?h(s,this.className):(s=e.parentNode,n=this.createContainer(s),s.insertBefore(n,e),n.appendChild(e)))},isRemovable:function(e){return e.tagName.toLowerCase()==this.elementTagName&&s(e)==this.elementSortedClassName&&this.elementHasProperties(e,this.elementProperties)&&!A(e,this.attrExceptions)&&this.elementHasAttributes(e,this.elementAttributes)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){var t=this,n=e.getNodes([1],function(e){return t.isEmptyContainer(e)}),e=[e],s=O(e);m(n,function(e){v(e,s)}),I(e,s)},undoToTextNode:function(e,t,n,s){var i;t.containsNode(n)||((i=t.cloneRange()).selectNode(n),i.isPointInRange(t.endContainer,t.endOffset)&&(W(n,t.endContainer,t.endOffset,s),t.setEndAfter(n)),i.isPointInRange(t.startContainer,t.startOffset)&&(n=W(n,t.startContainer,t.startOffset,s))),this.isRemovable(n)?C(n,s):g(n,this.className)},splitAncestorWithClass:function(e,t,n){var s=this.getSelfOrAncestorWithClass(e);s&&W(s,e,t,n)},undoToAncestor:function(e,t){this.isRemovable(e)?C(e,t):g(e,this.className)},applyToRange:function(e,t){var n=this,s=O((t=t||[])||[]),i=(e.splitBoundariesPreservingPositions(s),n.removeEmptyElements&&n.removeEmptyContainers(e),E(e)),r=(i.length&&(m(i,function(e){n.isIgnorableWhiteSpaceNode(e)||n.getSelfOrAncestorWithClass(e)||!n.isModifiable(e)||n.applyToTextNode(e,s)}),r=i[i.length-1],e.setStartAndEnd(i[0],0,r,r.length),n.normalize&&n.postApply(i,e,s,!1),I(t,s)),n.getEmptyElements(e));m(r,function(e){h(e,n.className)})},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(e){e=n.getSelection(e);e.setRanges(this.applyToRanges(e.getAllRanges()))},undoToRange:function(e,t){var n,s,i=this,r=O(t=t||[]),o=(e.splitBoundariesPreservingPositions(r),i.removeEmptyElements&&i.removeEmptyContainers(e,r),E(e)),a=o[o.length-1];if(o.length){i.splitAncestorWithClass(e.endContainer,e.endOffset,r),i.splitAncestorWithClass(e.startContainer,e.startOffset,r);for(var l=0,u=o.length;l<u;++l)n=o[l],(s=i.getSelfOrAncestorWithClass(n))&&i.isModifiable(n)&&i.undoToAncestor(s,r);e.setStartAndEnd(o[0],0,a,a.length),i.normalize&&i.postApply(o,e,r,!0),I(t,r)}a=i.getEmptyElements(e);m(a,function(e){g(e,i.className)})},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(e){var t=n.getSelection(e),e=n.getSelection(e).getAllRanges();this.undoToRanges(e),t.setRanges(e)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,s=0;n=t[s++];)if(!this.isIgnorableWhiteSpaceNode(n)&&T(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(e){e=n.getSelection(e);return this.isAppliedToRanges(e.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var t=[],n=this;return e.getNodes([3],function(e){e=n.getSelfOrAncestorWithClass(e);e&&!r(t,e)&&t.push(e)}),t},detach:function(){}},H.util={hasClass:a,addClass:h,removeClass:g,getClass:t,hasSameClasses:l,hasAllClasses:u,replaceWithOwnChildren:C,elementsHaveSameNonClassAttributes:b,elementHasNonClassAttributes:A,splitNodeAt:W,isEditableElement:x,isEditingHost:R,isEditable:P},n.CssClassApplier=n.ClassApplier=H,n.createClassApplier=function(e,t,n){return new H(e,t,n)},e.createAliasForDeprecatedMethod(n,"createCssClassApplier","createClassApplier",c)}),e},this);